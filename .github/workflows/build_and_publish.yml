name: Build and Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag to release (ignored when triggered by push tags)'
        required: false

jobs:
  build:
    name: Build PRG
    runs-on: windows-latest
    env:
      CONNECTIQ_SDK_ROOT: ${{ runner.temp }}\\connectiq-sdk
    outputs:
      built-prg: ${{ steps.build.outputs.prg-path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Download Connect IQ SDK
        run: |
          mkdir %CONNECTIQ_SDK_ROOT%
          curl -L "$Env:CONNECTIQ_SDK_URL" -o sdk.zip
          tar -xf sdk.zip -C %CONNECTIQ_SDK_ROOT% --strip-components=1
        shell: pwsh

      - name: Build with MonkeyBrains
        id: build
        run: |
          $sdkBin = "${Env:CONNECTIQ_SDK_ROOT}\\bin"
          $cmd = "java --% -Xms1g -Dfile.encoding=UTF-8 -Dapple.awt.UIElement=true -jar $sdkBin\\monkeybrains.jar -o bin\\rugbytimer.prg -f $(pwd)\\monkey.jungle -y $(pwd)\\developer_key -d fenix6_sim -w"
          Write-Host "Running: $cmd"
          Invoke-Expression $cmd
          echo "prg-path=bin\\rugbytimer.prg" | Out-File -Encoding ASCII -Append $Env:GITHUB_OUTPUT
        shell: pwsh

      - name: Upload PRG artifact
        uses: actions/upload-artifact@v4
        with:
          name: rugbytimer-prg
          path: bin/rugbytimer.prg

  release:
    name: Publish release + Connect IQ upload
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: rugbytimer-prg

      - name: Determine release tag
        id: tag
        run: |
          if [ -n "${{ github.event.release_tag }}" ]; then
            echo "tag=${{ github.event.release_tag }}" >> $Env:GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${{ github.ref_name }}" >> $Env:GITHUB_OUTPUT
          else
            echo "tag=ci-${{ github.run_id }}" >> $Env:GITHUB_OUTPUT
          fi
        shell: bash

      - name: Create GitHub release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: Release ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: bin/rugbytimer.prg
          asset_name: rugbytimer.prg
          asset_content_type: application/octet-stream

      - name: Push to Connect IQ Store
        if: ${{ env.IQ_STORE_TOKEN != '' }}
        env:
          IQ_STORE_TOKEN: ${{ secrets.CONNECTIQ_STORE_TOKEN }}
        run: |
          curl -X POST https://developerconnect.garmin.com/connect-iq-store/sales/v1/apps/upload \
            -H "Authorization: Bearer ${{ env.IQ_STORE_TOKEN }}" \
            -F "app=@bin/rugbytimer.prg" \
            -F "manifest=@monkey.jungle" \
            -F "notes=Automated release ${{ steps.tag.outputs.tag }}"
        shell: pwsh
